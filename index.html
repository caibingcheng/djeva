<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJEVA</title>

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="lib/gridmanager.css">
    <script src="lib/gridmanager.js"></script>
</head>

<style>
    html,
    body {
        padding: 0 0;
        margin: 0 5px;
    }

    .eva_low {
        color: rgb(23, 195, 23);
    }

    .eva_mid {
        color: rgb(117, 119, 117);
    }

    .eva_high {
        color: rgb(173, 17, 17);
    }

    .code_link {
        text-decoration: none;
        color: black;
        font-weight: bolder;
    }

    select {
        color: black;
        font-size: 16px;
        background: #e8e8e8;
        border: 2px solid #e8e8e8;
        border-radius: 6px;
        padding: 4px 6px;
        text-align: center;
        display: inline-block;
        cursor: pointer;
        text-decoration: none;
        text-transform: uppercase;
        outline: none;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }

    input[type='button'] {
        display: inline-block;
        color: black;
        font-size: 16px;
        background: #e8e8e8;
        border: 2px solid #e8e8e8;
        border-radius: 6px;
        padding: 4px 16px;
        text-align: center;
        -webkit-transition-duration: 0.4s;
        /* Safari */
        transition-duration: 0.4s;
        cursor: pointer;
        text-decoration: none;
        text-transform: uppercase;
    }

    input[type='button']:hover {
        border: 2px solid #008CBA;
        background-color: #008CBA;
        color: white;
    }

    .comment {
        color: #7a7a7a;
        font-size: 0.8rem;
        padding: 0 0;
        margin: 0 0;
    }

    header {
        line-height: 48px;
        width: 100%;
        padding: 0 0;
        margin: 0 0;
        position: relative;
    }

    main {
        height: 100%;
    }

    #selected_date {
        margin-left: 8px;
        font-weight: bolder;
    }

    .date-picker {
        position: absolute;
        top: 48px;
        left: 0;
        background: #e8e8e8;
        border: 2px solid #e8e8e8;
        border-radius: 6px;
        padding: 8px;
        display: none;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .date-picker.show {
        display: block;
    }

    .date-picker-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }

    .date-picker-title {
        font-weight: bolder;
    }

    .date-picker-nav {
        background: #e8e8e8;
        border: 2px solid #e8e8e8;
        border-radius: 6px;
        width: 28px;
        height: 28px;
        padding: 0;
        cursor: pointer;
        font-size: 16px;
        line-height: 24px;
    }

    .date-picker-nav:disabled {
        color: #9b9b9b;
        cursor: not-allowed;
    }

    .date-picker-weekdays,
    .date-picker-days {
        display: grid;
        grid-template-columns: repeat(7, 32px);
        gap: 4px;
        justify-content: center;
        text-align: center;
    }

    .date-picker-weekdays {
        font-size: 12px;
        color: #7a7a7a;
        margin-bottom: 4px;
    }

    .date-picker-day,
    .date-picker-empty {
        width: 32px;
        height: 28px;
        border-radius: 4px;
        text-align: center;
    }

    .date-picker-day {
        border: 1px solid #e0e0e0;
        background: #f8f8f8;
        cursor: pointer;
    }

    .date-picker-day:hover {
        border-color: #008CBA;
    }

    .date-picker-day.selected {
        background: #008CBA;
        color: white;
        border-color: #008CBA;
    }

    .date-picker-day:disabled {
        background: #f0f0f0;
        color: #9b9b9b;
        cursor: not-allowed;
        border-color: #e0e0e0;
    }

    .date-picker-empty {
        border: 1px solid transparent;
        background: transparent;
    }

    footer {
        position: fixed;
        bottom: 0;
        line-height: 32px;
        width: 100%;
        padding: 0 0;
        margin: 0 0;
    }
</style>

<body>
    <header>
        <input type="button" id="date_picker_button" value="选择日期">
        <span id="selected_date"></span>
        <span id="trading_week"></span>
        <div id="date_picker" class="date-picker">
            <div class="date-picker-header">
                <button type="button" id="date_picker_prev" class="date-picker-nav">‹</button>
                <span id="date_picker_title" class="date-picker-title"></span>
                <button type="button" id="date_picker_next" class="date-picker-nav">›</button>
            </div>
            <div class="date-picker-weekdays">
                <span>一</span>
                <span>二</span>
                <span>三</span>
                <span>四</span>
                <span>五</span>
                <span>六</span>
                <span>日</span>
            </div>
            <div id="date_picker_days" class="date-picker-days"></div>
        </div>
    </header>
    <main>
        <table></table>
    </main>
    <footer>
        <p class="comment">重要提示：投资有风险，估值数据仅供参考，不构成任何投资建议。</p>
    </footer>


    <script type="text/javascript" src="djeva.js"></script>
    <script>
        var djeva = get_djeva();
        let week_obj = document.querySelector("#trading_week");
        let selected_date_obj = document.querySelector("#selected_date");
        let date_picker = document.querySelector("#date_picker");
        let date_picker_button = document.querySelector("#date_picker_button");
        let date_picker_title = document.querySelector("#date_picker_title");
        let date_picker_days = document.querySelector("#date_picker_days");
        let date_picker_prev = document.querySelector("#date_picker_prev");
        let date_picker_next = document.querySelector("#date_picker_next");

        function setDataList(id, datalist) {
            let dl = document.getElementById(id);
            dl.innerHTML = "";
            for (var index in datalist) {
                dl.add(new Option(datalist[index], datalist[index]));
            }
        }

        function sortByKey(arr, key = "") {
            if (typeof (arr) == "string")
                arr = JSON.parse(arr);
            return arr.sort(function (a, b) {
                if (key == "")
                    return a - b;
                return a[key] - b[key];
            });
        }

        function padDate(value) {
            return String(value).padStart(2, '0');
        }

        function formatDate(year, month, day) {
            return year + '-' + month + '-' + day;
        }

        function isDataAvailable(year, month, day) {
            if (!djeva['data'][year] || !djeva['data'][year][month]) {
                return false;
            }
            return djeva['data'][year][month].includes(day);
        }

        function getMonthRange() {
            let minValue = null;
            let maxValue = null;
            Object.keys(djeva['data']).forEach((year) => {
                Object.keys(djeva['data'][year]).forEach((month) => {
                    let value = parseInt(year) * 12 + parseInt(month);
                    if (minValue === null || value < minValue) {
                        minValue = value;
                    }
                    if (maxValue === null || value > maxValue) {
                        maxValue = value;
                    }
                });
            });
            return {
                min: minValue,
                max: maxValue
            };
        }

        function getLatestDate() {
            let latestValue = -1;
            let latestDate = {
                year: "",
                month: "",
                day: ""
            };
            Object.keys(djeva['data']).forEach((year) => {
                Object.keys(djeva['data'][year]).forEach((month) => {
                    djeva['data'][year][month].forEach((day) => {
                        let value = parseInt(year) * 10000 + parseInt(month) * 100 + parseInt(day);
                        if (value > latestValue) {
                            latestValue = value;
                            latestDate = {
                                year: year,
                                month: month,
                                day: day
                            };
                        }
                    });
                });
            });
            return latestDate;
        }

        let monthRange = getMonthRange();
        let latestDate = getLatestDate();
        let selectedYear = latestDate.year;
        let selectedMonth = latestDate.month;
        let selectedDay = latestDate.day;
        let currentYear = selectedYear;
        let currentMonth = selectedMonth;

        function updateWeekday() {
            let date = new Date(parseInt(selectedYear), parseInt(selectedMonth) - 1, parseInt(selectedDay));
            let week = {
                0: "星期天",
                1: "星期一",
                2: "星期二",
                3: "星期三",
                4: "星期四",
                5: "星期五",
                6: "星期六",
            };
            week_obj.innerHTML = ' · ' + week[date.getDay()];
        }

        function updateSelectedLabel() {
            selected_date_obj.innerHTML = formatDate(selectedYear, selectedMonth, selectedDay);
        }

        function setSelectedDate(year, month, day) {
            selectedYear = year;
            selectedMonth = month;
            selectedDay = day;
            currentYear = year;
            currentMonth = month;
            updateSelectedLabel();
            updateWeekday();
            query(formatDate(selectedYear, selectedMonth, selectedDay));
        }

        function renderCalendar() {
            let yearValue = parseInt(currentYear);
            let monthValue = parseInt(currentMonth);
            let daysInMonth = new Date(yearValue, monthValue, 0).getDate();
            let firstDayIndex = (new Date(yearValue, monthValue - 1, 1).getDay() + 6) % 7;
            date_picker_title.innerHTML = currentYear + ' 年 ' + monthValue + ' 月';
            date_picker_days.innerHTML = "";

            for (let index = 0; index < firstDayIndex; index++) {
                let emptySlot = document.createElement('div');
                emptySlot.className = 'date-picker-empty';
                date_picker_days.appendChild(emptySlot);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                let dayValue = padDate(day);
                let dayButton = document.createElement('button');
                dayButton.type = 'button';
                dayButton.className = 'date-picker-day';
                dayButton.textContent = day;
                if (!isDataAvailable(currentYear, currentMonth, dayValue)) {
                    dayButton.disabled = true;
                }
                if (currentYear === selectedYear && currentMonth === selectedMonth && dayValue === selectedDay) {
                    dayButton.classList.add('selected');
                }
                dayButton.onclick = function () {
                    if (dayButton.disabled) {
                        return;
                    }
                    setSelectedDate(currentYear, currentMonth, dayValue);
                    date_picker.classList.remove('show');
                    renderCalendar();
                };
                date_picker_days.appendChild(dayButton);
            }

            let currentValue = yearValue * 12 + monthValue;
            date_picker_prev.disabled = currentValue <= monthRange.min;
            date_picker_next.disabled = currentValue >= monthRange.max;
        }

        function shiftMonth(step) {
            let yearValue = parseInt(currentYear);
            let monthValue = parseInt(currentMonth) + step;
            if (monthValue === 0) {
                monthValue = 12;
                yearValue -= 1;
            } else if (monthValue === 13) {
                monthValue = 1;
                yearValue += 1;
            }
            let newValue = yearValue * 12 + monthValue;
            if (newValue < monthRange.min || newValue > monthRange.max) {
                return;
            }
            currentYear = String(yearValue);
            currentMonth = padDate(monthValue);
            renderCalendar();
        }

        date_picker_button.onclick = function (event) {
            event.stopPropagation();
            date_picker.classList.toggle('show');
        };

        date_picker_prev.onclick = function (event) {
            event.stopPropagation();
            shiftMonth(-1);
        };

        date_picker_next.onclick = function (event) {
            event.stopPropagation();
            shiftMonth(1);
        };

        date_picker.onclick = function (event) {
            event.stopPropagation();
        };

        document.addEventListener('click', function () {
            date_picker.classList.remove('show');
        });

        setSelectedDate(selectedYear, selectedMonth, selectedDay);
        renderCalendar();

        function sortingData(data, query) {
            let sortProps = "DESC";
            let sortOrder = "";
            Object.keys(query).forEach((key) => {
                if (query[key] === "ASC" || query[key] === "DESC") {
                    sortProps = key.split("_")[1];
                    sortOrder = query[key];
                }
            });

            return ((list, sortProps, sortOrder) => {
                if (sortOrder === "ASC") {
                    return sortByKey(list, sortProps);
                }
                if (sortOrder === "DESC") {
                    return sortByKey(list, sortProps).reverse();
                }
                return list;
            })(data, sortProps, sortOrder);
        }

        function getDJEvaList(params, url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState !== 4) {
                        return;
                    }
                    if (xhr.status >= 200 && xhr.status < 300 || xhr.status === 304) {
                        resolve(sortingData(xhr.response, params));
                    } else {
                        reject(xhr);
                    }
                };

                xhr.send();
            });
        };

        function query(date) {
            document.querySelector('table').GM({
                gridManagerName: 'djeva',
                ajaxData: function (settings, params) {
                    return getDJEvaList(params, 'json/' + date + '.json');
                },
                responseHandler: function (response) {
                    document.title = 'DJEVA ' + response[0]['date'];
                    response = {
                        'data': response,
                        'totals': response.length
                    };

                    return response;
                },
                supportCheckbox: false,
                supportAutoOrder: false,
                supportDrag: false,
                pageSizeKey: 'totals',
                height: '100vh - 80px',
                columnData: [
                    {
                        key: 'index_code',
                        text: '代码',
                        template: function (cell, row, index, key) {
                            let link = 'https://danjuanapp.com/dj-valuation-table-detail/' + cell;
                            let content = row['name'] + ' (' + cell + ')';
                            return '<a class="code_link" href="' + link + '">' + content + '</a>';
                        },
                        sorting: '',
                    }, {
                        key: 'eva_type',
                        text: '估值',
                        template: function (cell, row, index, key) {
                            eva_type = {
                                'low': '<span class="eva_low">偏低</span>',
                                'mid': '<span class="eva_mid">适中</span>',
                                'high': '<span class="eva_high">偏高</span>',
                                'unsort': '',
                            };
                            return eva_type[cell];
                        },
                        sorting: '',
                    }, {
                        key: 'pe',
                        text: 'PE',
                        sorting: '',
                    }, {
                        key: 'pe_percentile',
                        text: 'PE百分位',
                        template: function (cell, row, index, key) {
                            return (cell * 100).toFixed(2) + '%';
                        },
                        sorting: '',
                    }, {
                        key: 'pb',
                        text: 'PB',
                        sorting: '',
                    }, {
                        key: 'pb_percentile',
                        text: 'PB百分位',
                        template: function (cell, row, index, key) {
                            return (cell * 100).toFixed(2) + '%';
                        },
                        sorting: '',
                    }, {
                        key: 'roe',
                        text: 'ROE',
                        template: function (cell, row, index, key) {
                            return (cell * 100).toFixed(2) + '%';
                        },
                        sorting: '',
                    }, {
                        key: 'yeild',
                        text: '股息率',
                        template: function (cell, row, index, key) {
                            return (cell * 100).toFixed(2) + '%';
                        },
                        sorting: '',
                    }, {
                        key: 'peg',
                        text: '预测PEG',
                        sorting: '',
                    },
                ]
            });
        }
    </script>

</body>

</html>
